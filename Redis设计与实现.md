# 数据结构


## 简单动态字符串SDS


定义`len free buf三个字段`


- redis只会使用c作为字面量
- o(1)获取字符串长度
- 杜绝缓存区溢出
- 减少修改长度是需要的内存重分配次数
- 二进制安全
- 兼容c部分函数

## 链表


特性：双端、无环、带表头和表位指针、带链表长度计数器、多态（可保存各种不同类型的值）

## 字典

- 哈希表作为底层实现
- 根据键计算出索引值->放到指定的索引上
- 使用链地址法解决哈希冲突，新节点添加到表头位置
- rehash 扩容和缩容，每个字典带两个哈希表，一个平时使用，一个rehash使用，渐进式的rehash，不是一次性完成

## 跳跃表

- 有序集合的底层实现之一
- 由zskiplist和zskiplistNode两个结构组成，zskiplist保存跳跃表信息（头尾节点 长度），zskiplistNode保存跳跃表节点
- 跳跃表层高是1-32的随机数
- 多个节点可以有相同的分值，成员对象必须是唯一的
- 按照分值大小排序，分值相同按照成员对象的大小排序

## 整数集合

- 集合键的底层实现之一
- 整数集合底层为有序、无重复的数据
- 有需要时会根据先添加的元素类型，改变数据类型
- 升级操作为整数集合带来灵活性，尽可能的节约内存
- 只支持升级，不支持降级

## 压缩列表

- 为节约内存而开发的顺序性数据结构
- 压缩列表被用作列表键和哈希键的底层实现之一
- 包含多个节点，每个节点保存一个字节数组or整数值
- 连锁更新：保存前一个节点的长度，大于254使用5字节，小于使用1字节
- 添加新节点or删除节点，可能会引发连锁更新操作，但出现几率不高

# 对象


包括 字符串、列表、哈希、集合和有序集合

实现基于引用计数的内存回收机制

访问时间记录信息，计算空转时长

### 字符串对象

- int、raw、embstr
- embstr专门用于保存短字符串的一种编码方式，一次内存分配一块连续空间，包含redispbject和sdshdr两个结构
- 会进行编码转换，embstr编码实际上是只读的。
- 字符串对象是五种类型中唯一会被其他类型嵌套的对象

### 列表对象

- ziplist或linkedlist

### 哈希对象

- ziplist或hashtable

### 集合对象

- 整数集合or hashtable（字典的值为null）

### 有序集合对象

- ziplist（第一个保存成员，第二个保存分值） or skiplist
- skiplist编码使用zset结构，包括字典和跳跃表，实现不同的功能，提高效率，通过指针共享相同的成员和分值，不会浪费内存

### 类型检查和命令多态

- redisobject的type属性确定类型
- 基于命令的多态和基于编码的多态

### 内存回收

- 引用计数：创建对象、操作对象和释放对象

### 对象共享

- 指针指向现有值对象
- 引用计数+1
- 会共享0-9999的字符串对象

### 对象的空转时长

- 记录对象最后一次被命令访问的时间，用于计算空转时间

# 笔记


map kv外层封装，hash是底层实现之一

哈希 空间换时间 

哈希算法

链表

连续内存 缓存 

cpu缓存？

新的list编码类型 quicklist
