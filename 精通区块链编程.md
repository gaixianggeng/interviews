# 精通区块链编程

## 比特币介绍

比特币既是构成数字货币生态系统基础概念和技术的总称，又是比特币网络参与者存储和传输的货币单位
比特币是分布式的点对点的系统，比特币是通过挖矿的流程创造出来的
挖矿流程涉及在打包处理比特币交易过程中矿工竞争式的寻找一个数学问题的解（寻找符合条件的hash值）
比特币挖矿流程代替了中央银行的货币发行和结算功能，通过分布式架构取代中央银行的地位
比特币总数限制在2100w以内

### 比特币的创新

- 去中心化的点对点网络（比特币协议）
- 一本公开的交易总账
- 一套可独立校验交易和发行货币的规则（共识规则）
- 一种通过全球去中心化对有效的区块链达成共识的机制（工作量证明算法）

最关键的创新是使用分布式计算系统（工作量证明算法）每十分钟进行一次全球兴致的“选举”，从而让分布式网络达成关于已经发生交易状态的共识

### 比特币钱包

- 比特币系统常见的用户界面
- 常见的三种钱包：桌面全节点客户端、手机轻量级钱包、网络第三发钱包

私钥

比特币地址

比特币交易是不可撤销的

## 比特币工作原理

交易、区块、挖矿和区块链

**比特币系统**由用户、交易和矿工三方构成，用户使用包含秘钥的钱包、交易在整个网络传播、矿工则生产（通过竞争性计算）出共识性区块链，也就是所有交易的公共权威账本

**比特币交易** 一笔交易是告知全网这部分比特币持有者已经授权把它转给新的持有者，新的持有者可以创造新的交易花掉所持有的的比特币，而这笔交易又再次将比特币授权给另一位持有者，形成一条所有者的链表

许多比特币交易包含指向新的持有者的地址和现持有者的地址，被称作“找零”地址

钱包应用可以在离线时建立交易

比特币交易不需要连接比特币网络的时候建立和签署

一个运行**全节点客户端**的比特币钱包实际上包含整个区块链上每笔交易的未消费输出和副本，这使得一个钱包既能构建交易输入，又能基于正确的输入快速验证收到的新交易，然而全节点客户端会使用大量的硬盘空间，大多数用户钱包使用轻量级客户端，只维护自己未消费的输出。

**交易的输出**以脚本的形式被创建，它设置对兑换价值的保护，只能通过引导对这个脚本的解答才能兑换。

交易费用作为矿工检验交易、包括到一个区块并记录在区块链上的费用

区块链网络的目的是将交易和区块传播给所有参与者

传播：任何收到了之前没见过的有效交易的比特币节点，会立即想连在它之上的所有节点转发，这个传播技巧叫做泛滥。

**比特币挖矿** 通过挖矿的过程被检验并被包括到一个区块之中，才会成为区块链的一部分。

打包过程需要大量计算来证明，检验仅需要很少的计算量

挖矿的作用

- 挖矿节点通过参考比特币的共识规则检验所有交易，挖矿通过拒绝无效或者不正常的交易为比特币交易提供安全保证
- 挖矿在构建区块是会创造新的比特币，类似中央银行引发新纸币，每个区块创造的比特币的数量是有限的，并按照随着时间减少的固定发行规则。

挖矿在成本和汇报之间达成平衡，使用电力解决数学问题。矿工通过新的比特币和交易手续费获取回报，矿工只有按照共识规则正确验证所有交易之后才会获得回报，这种平衡在没有中央权威的情况下为比特币提供了安全保证。

**工作量证明算法**需要重复对区块的头和一个随机数使用sha256加密算法计算哈希值直到出现预定匹配的解答，第一个找到解答的矿工赢得这一轮，并将得到的区块发布到区块链上。

**挖掘交易**

新的交易流入网络，当被比特币网络节点看到时，便会被加到每个节点维护的未验证的临时池子，当打包新块时，会从临时的池子里选择未验证的交易加入新区块，使用工作量证明算法来证明新块的有效性

交易加入到区块，会按照手续费和其他条件排序，每个矿工从网络收到之前的区块时，便知道自己输掉了上一轮，开始新的挖掘，创建新的区块，填入交易和之前区块的指纹，进行下一轮。

区块一个叠一个，逆转交易的难度将指数级增加，从而让他变得更加被网络信任。

每个比特币客户端可独立验证交易是合法的和可消费的

## 核心客户端

[https://zh.wikipedia.org/wiki/對等網路](https://zh.wikipedia.org/wiki/%E5%B0%8D%E7%AD%89%E7%B6%B2%E8%B7%AF) p2p

比特币对等网络的节点主要由志愿者和一些构建比特币应用程序的商业机构运行，比特币节点具有直接和权威的比特币区块链视图并且拥有所有交易的副本

可以通过配置比特币呵呵核心通过丢弃旧块来减少区块链大小

比特币核心客户端实现了json-rpc接口

交易id在交易未必确认前不具有权威性

## 密钥和地址

比特币是基于密码学的

比特币的通信和交易数据并没有加密，也不需要通过加密来保护资金

比特币所有权是通过数字密钥、比特币地址和数字签名建立起来的，数字密钥不存储在网络中，由用户创建、存在钱包中，数字密钥完全独立于比特币协议，可以由钱包生成和管理，密钥使得比特币的去中心化的信任和控制、所有权认证和基于密码学的验证的安全模型得以实现

任何人拥有了密钥副本就拥有了对该账户的比特币控制权

用于支出资金的数字签名称为见证

密钥是成对出现的，由私钥和公钥组成，比特币地址由公钥生成并对应与这个公钥

不可逆的数学函数 单向加密函数 椭圆曲线乘法

密码对包含一个私钥和从它派生出来唯一的公钥，公钥用于接收比特币，私钥用于为比特币支付进行交易签名

公钥和私钥的数学关系：允许私钥在消息上生成签名，签名可以在不泄露私钥的情况下通过公钥进行验证

支付时，比特币所有者需要在交易中展示公钥和签名（每次签名都不同，均由同一个私钥创建），比特币网络对其验证是否有效，确认支付者对比特币的拥有权

私钥k通常是一个随机选择的数字，基于私钥可以使用椭圆曲线乘法这个单向加密函数来生成一个公钥K，基于公钥K可以使用单向加密函数生成比特币地址A

非对称加密？

对私钥的的所有权和控制权是用户对相应的比特币地址中所有资金的控制根源

私钥在任何时候都需要保密，一旦丢失无法恢复

熵源（随机性来源）

比特币使用操作系统底层的随机数生成器来产生256位的熵

通过椭圆曲线函数可以从私钥得到公钥，不可逆 K=k*G（生成点的常数点）k和K的关系是固定的，只能单向运算

比特币地址是由数字和字母组成的字符串，由公钥生成的比特币地址以数字1开头

比特币地址由公钥经过单向的加密散列算法得到，散列算法是一种单向函数，能够接受任意长度的输入值产生一个指纹或散列。

加密散列函数作为比特币地址、脚本地址以及挖矿的工作量证明算法

base58check编码，提高可读性和录入的正确性

base58是不包括0、O、1、I的大小写和+ / 的其他字母和数字组成

校验和checksum是添加到正在编码的数据末端的额外四个字节

前缀+数据+校验和 比特币地址以1开头，私钥wif以5开头

私钥和公钥都可以以多种不同的格式呈现，虽然格式不同，但密钥所编码的数字没有改变

私钥所有的格式都对应256位的数字

wif压缩格式的私钥以字母k、l开头

公钥分为非压缩格式公钥04和压缩格式公钥02偶数/03奇数

将压缩的公钥引入比特币是为了减少交易大小，并为存储比特币区块链节点节省磁盘空间

一个私钥可以生成两种不同格式的公钥（压缩、非压缩），这两种可以生成两种不同的比特币地址，但是私钥是同一个

压缩格式私钥表示用于生成压缩格式公钥的私钥，多了后缀01，表明来自较新的钱包

在实现了压缩格式公钥较新的钱包中，私钥只能被导出为wif压缩格式（k\l），较老的只能导出为wif格式5为前缀

加密私钥标准BIP-38 6P开头的base58check编码的加密私钥

以数字3开头的比特币地址是P2SH（pay-to-script hash）地址，有时被错误地称为多重签名或多重签名地址。它们指定比特币交易中受益人为一个脚本的散列，而不是公钥的所有者。不同于P2PKH（pay-to-public-key-hash），交易会发送资金到传统的以1开头的比特币地址，资金被发送到以3开头的地址时，需要的不仅仅是一个公钥的散列值和一个私钥签名来作为所有者证明。在创建地址的时候，这些具体的要求会被指定在脚本中，这个地址的所有输入都将受到相同的要求。

P2SH函数最常见的实现是多重签名地址脚本。顾名思义，底层脚本需要多个签名来证明所有权，此后才能消费资金。设计比特币多重签名特性时需要从总共N个密钥中获得M个签名（也被称为“阈值”），被称为M-N多重签名，其中M等于或小于N

靓号地址

认识到比特币地址不过是由Base58字母代表的一个数字是非常重要的

生成一个靓号地址是一项使用蛮力的过程：尝试一个随机密钥，检查生成的地址是否和所需的样式相匹配，重复这个过程直到成功地找到靓号为止。

纸钱包是打印在纸张上的比特币私钥

## 钱包

广义上讲，钱包是一个应用程序，为用户提供交互界面。钱包控制用户访问权限，管理私钥和地址，跟踪余额以及创建和签名交易。狭义上讲，从程序员的角度来看，“钱包”是指用于存储和管理用户私钥的数据结构。

钱包只包含密钥。比特币被记录在比特币网络的区块链中。用户通过使用钱包中的密钥签署交易来控制网络上的比特币。从某种意义上说，比特币钱包是一个钥匙扣（keychain）。

比特币以交易记录（通常记为vout或txout）的形式存储在区块链中。

钱包分类

- 第一种类型是非确定性钱包（nondeterministic wallet），其中每个私钥都是从随机数独立生成的，密钥彼此之间无关联。这种钱包也称为简单钥匙串（Just aBunch Of Keys，一堆私钥的集合），简称JBOK钱包。
- 第二种类型是确定性钱包（deterministic wallet），其中所有的私钥都是从一个主私钥派生出来，这个主私钥即为种子（seed）。该类型钱包中所有私钥都相互关联，如果有原始种子，则可以再次生成全部私钥。确定性钱包有许多不同的密钥派生方法。最常用的派生方法是使用树状结构，称为分层确定性钱包或HD钱包。确定性钱包由种子派生出来的。为了便于使用，种子被编码为英文单词，也称为助记词。

非确定性钱包：钱包只是随机生成私钥的集合 难以管理、备份以及导入

确定性（种子）钱包：所包含的私钥都是通过使用单向散列（hash）函数从公共种子派生出来的。种子是一串随机生成的数字，这串数字结合索引编号和“链码”可派生出其他私钥

确定性钱包目前最高级的版本是通过BIP-32标准定义的HD钱包。HD钱包的私钥是以树状结构派生的，父私钥可以派生出一系列子私钥，每个子私钥又可以派生出一系列孙私钥，以此类推，可以无限派生。

HD钱包优点

- 树状结构可以用来表达额外的组织含义
- 它可以让用户去创建一系列公钥而无须知晓相对应的私钥。这样HD钱包可在安全性不高的服务器中使用或者作为收款专用，为每笔交易提供不同的公钥。

助记词，单词序列很重要 标准由BIP-39定义 用户可以导出在其中一个钱包上生成的助记词，并将其导入另一个钱包，以恢复所有的交易、密钥和地址。

助记词编码是表示（可编码成）确定性钱包的随机数种子的英语单词序列。助记词足以重新创建种子，并从种子那里重新创建钱包和所有派生的私钥。

助记词是由钱包使用BIP-39中定义的标准化过程自动生成的。钱包从熵源（随机源）开始，添加校验码（check-sum），然后将随机数映射到单词列表：

1）创建一个128～256位的随机数（熵）。

2）提取随机数的SHA256散列值的前x位（x等于随机数位数除以32）作为检验和。

3）将校验码添加到随机序列的末尾。

4）将序列按11位进行划分。

5）将每11位的值映射到一个含2048（211）个单词的预定义字典中。

6）生成的有顺序的单词组就是助记词。

助记词表示长度为128～256位的熵（随机数）。使用密钥延伸函数PBKDF2，熵被用于派生出更长的（512位）种子。将所得的种子用于构建确定性钱包并派生密钥。

助记词和盐（slat）

7）PBKDF2密钥延伸函数的第一个参数是从步骤6生成的助记词。

8）PBKDF2密钥延伸函数的第二个参数是盐。由固定的字符串“mnemonic”与可选的用户输入的密码字符串连接组成。

9）PBKDF2将助记词和盐作为参数，调用2048次HMAC-SHA512散列算法，生成一个512位的值作为其延伸的最终输出。这个512位的值就是种子。

本质上，没有“错误”的密码，所有密码都是有效的，它们只是会导致不同的种子，形成一大批可能未初始化的钱包

HD钱包从单个128位、256位，或512位的随机数根种子（root seed）中创建。最常见的情况是，这个种子是从助记词产生的

HD钱包中的所有私钥都是从这个根种子确定性地派生出来的 只需传输根种子的助记词即可。

创建主私钥以及HD钱包的主链码的过程：

![Untitled](./%E7%B2%BE%E9%80%9A%E5%8C%BA%E5%9D%97%E9%93%BE%E7%BC%96%E7%A8%8B/Untitled.png)

主链码（c）用于从父私钥创造子私钥的那个函数中引入随机数（熵）

分层确定性钱包使用CKD（child key derivation，子私钥派生）函数从父私钥派生出子私钥。

子密钥派生函数是基于单向散列函数的，这个函数结合了：

一个父私钥或者公钥（ECDSA未压缩密钥）

一个256位的链码

一个32位的索引码

链码是用来给这个确定性过程引入随机数据的，以便知道索引编号和子私钥也不足以派生其他子私钥

初始链码种子（在树的根部）是用根种子生成的，而后续的链码从各自的父链码中派生出来。

一个私钥、一个链码以及想要的子私钥的索引号，私钥派生函数就可以用来创建私钥树上任何层级的子私钥。将私钥以及链码这两个重要的部分组合在一起，称为扩展密钥（extended key）。术语“扩展密钥”也被认为是“可扩展的密钥”，因为这种密钥可以用来派生子密钥。

两种类型的扩展密钥：1）私钥以及链码组成扩展私钥，它可用来派生子私钥（子私钥可以用来派生子公钥）。2）公钥以及链码组成扩展公钥，它可以用来派生子公钥

扩展密钥使用特殊的版本号进行Base58Check编码，所以编码的字符中，会出现“xprv”或“xpub”这样的前缀（扩展私钥前缀为xprv，扩展公钥前缀为xpub）

两种生成子公钥的方法：通过子私钥生成，或者直接通过父公钥生成。

公钥部署：服务器或者应用程序可以拥有扩展公钥的副本但没有私钥。这种部署方式可以创造出无限数量的公钥以及比特币地址，但是发送到这些地址里的比特币此时都不能花费。

HD钱包使用了强派生（hardened derivation）函数来替代原来的派生函数。它可以“打破”父公钥以及子链码之间的关系。这个强派生函数使用了父私钥去推导子链码，而不是父公钥。

建议主私钥所衍生的第一层级的子私钥都使用强派生

区分私钥是从常规派生函数还是从强化派生函数中派生出来，索引码的取值分为两个范围。索引码在0和231-1（0x0到0x7FFFFFFF）之间的用于常规派生。索引码在231和232-1（0x80000000到0xFFFFFFFF）之间的用于强派生。因此，索引码小于231就意味着子私钥是常规的，而大于或者等于231的子私钥就是强化型的。

强派生的索引号码也是从0开始展示的，但是右上角有一个小撇号。

BIP-44指定了包含5个预定义树状层级的结构：

![Untitled](./%E7%B2%BE%E9%80%9A%E5%8C%BA%E5%9D%97%E9%93%BE%E7%BC%96%E7%A8%8B/Untitled%201.png)

第1层的purpose总是被设定为44'。

第2层的“coin_type”特指币种，允许多货币HD钱包中的货币在第二个层级下有自己的子树结构。这是目前已经定义的三种货币：Bitcoin使用m/44'/0'、Bitcoin Testnet使用m/44'/1'，以及Litecoin使用m/44'/2'。